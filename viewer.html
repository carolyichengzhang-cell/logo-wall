<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Logo å¢™ - æµè§ˆä¸ä¸‹è½½</title>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f0f2f5;
      min-height: 100vh;
      color: #333;
    }

    /* é¡¶éƒ¨ */
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 40px 20px 32px;
      text-align: center;
      color: #fff;
      position: relative;
    }
    .header h1 { font-size: 2.2rem; font-weight: 800; margin-bottom: 8px; letter-spacing: 1px; }
    .header p { font-size: 1rem; opacity: 0.85; max-width: 600px; margin: 0 auto; }
    .header-stats {
      display: flex;
      justify-content: center;
      gap: 32px;
      margin-top: 20px;
    }
    .header-stat {
      text-align: center;
    }
    .header-stat .num {
      font-size: 2rem;
      font-weight: 800;
      display: block;
      line-height: 1.2;
    }
    .header-stat .label {
      font-size: 0.8rem;
      opacity: 0.75;
    }
    .admin-link {
      position: absolute;
      top: 16px;
      right: 20px;
      color: rgba(255,255,255,0.5);
      text-decoration: none;
      font-size: 0.8rem;
      transition: color 0.2s;
    }
    .admin-link:hover { color: rgba(255,255,255,0.9); }

    .container { max-width: 1400px; margin: 0 auto; padding: 24px 20px; }

    /* ç­›é€‰é¢æ¿ */
    .filter-panel {
      background: #fff;
      border-radius: 16px;
      padding: 24px 28px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      margin-bottom: 24px;
    }
    .filter-section {
      margin-bottom: 16px;
    }
    .filter-section:last-child { margin-bottom: 0; }
    .filter-section-title {
      font-size: 0.88rem;
      font-weight: 700;
      color: #555;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .filter-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .filter-tag {
      padding: 6px 18px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      border: 2px solid #e8e8e8;
      background: #fff;
      color: #666;
      transition: all 0.2s;
      user-select: none;
    }
    .filter-tag:hover { border-color: #667eea; color: #667eea; }
    .filter-tag.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      border-color: transparent;
    }
    .filter-tag.active-green {
      background: linear-gradient(135deg, #52c41a, #389e0d);
      color: #fff;
      border-color: transparent;
    }
    .filter-tag.active-orange {
      background: linear-gradient(135deg, #f5af19, #f12711);
      color: #fff;
      border-color: transparent;
    }
    .filter-tag .tag-count {
      font-size: 0.75rem;
      opacity: 0.8;
      margin-left: 4px;
    }

    /* æœç´¢æ¡† */
    .search-bar {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
    }
    .search-input {
      flex: 1;
      padding: 10px 16px;
      border: 2px solid #e8e8e8;
      border-radius: 12px;
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.2s;
    }
    .search-input:focus { border-color: #667eea; }
    .search-input::placeholder { color: #bbb; }

    /* ç»“æœç»Ÿè®¡ + æ“ä½œæ  */
    .result-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .result-count {
      font-size: 0.95rem;
      color: #666;
    }
    .result-count strong { color: #667eea; font-size: 1.1rem; }
    .result-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* æŒ‰é’® */
    .btn {
      padding: 10px 22px;
      border: none;
      border-radius: 10px;
      font-size: 0.88rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; }
    .btn-excel { background: linear-gradient(135deg, #36d1dc, #5b86e5); color: #fff; }
    .btn-ppt { background: linear-gradient(135deg, #f5af19, #f12711); color: #fff; }
    .btn-outline {
      background: #fff;
      color: #667eea;
      border: 2px solid #667eea;
    }
    .btn-outline:hover { background: #f0f1ff; }
    .btn-sm { padding: 7px 14px; font-size: 0.82rem; }

    /* Logo ç½‘æ ¼ */
    .logo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .logo-card {
      background: #fff;
      border: 2px solid #f0f0f0;
      border-radius: 14px;
      padding: 16px 10px 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.25s;
      position: relative;
      user-select: none;
    }
    .logo-card:hover {
      border-color: #d0d4ff;
      box-shadow: 0 4px 16px rgba(102,126,234,0.12);
      transform: translateY(-2px);
    }
    .logo-card.selected {
      border-color: #667eea;
      background: #f8f9ff;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.15);
    }
    .logo-card .card-check {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px solid #ddd;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: transparent;
      transition: all 0.2s;
    }
    .logo-card.selected .card-check {
      border-color: #667eea;
      background: #667eea;
      color: #fff;
    }
    .logo-card img {
      width: 60px;
      height: 60px;
      object-fit: contain;
      border-radius: 14px;
      margin-bottom: 8px;
      background: #fafbfc;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }
    .logo-card .card-name {
      font-size: 0.82rem;
      font-weight: 600;
      color: #333;
      max-width: 110px;
      margin: 0 auto;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .logo-card .card-tags {
      display: flex;
      gap: 3px;
      margin-top: 6px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .mini-tag {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 8px;
      font-size: 0.68rem;
      font-weight: 600;
    }
    .mini-tag.product { background: #667eea18; color: #667eea; }
    .mini-tag.region { background: #52c41a18; color: #389e0d; }
    .mini-tag.category { background: #764ba218; color: #764ba2; }

    /* ç©ºçŠ¶æ€ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
    .empty-state h3 { font-size: 1.1rem; color: #666; margin-bottom: 6px; }
    .empty-state p { font-size: 0.9rem; }

    /* Logo å¢™å±•ç¤º */
    .wall-section { display: none; margin-top: 24px; }
    .wall-section.visible { display: block; }

    .wall-toolbar {
      background: #fff;
      border-radius: 14px;
      padding: 18px 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
      align-items: center;
    }
    .wall-toolbar label {
      font-size: 0.88rem;
      font-weight: 500;
      color: #555;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .wall-toolbar select,
    .wall-toolbar input[type="range"] {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 5px 8px;
      font-size: 0.88rem;
      outline: none;
    }
    .wall-toolbar input[type="range"] { width: 110px; }
    .wall-toolbar input[type="color"] {
      width: 32px; height: 32px; padding: 2px;
      border: 1px solid #ddd; border-radius: 8px; cursor: pointer;
    }
    .wall-toolbar-actions {
      margin-left: auto;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .logo-wall-wrapper {
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .logo-wall {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 28px;
      padding: 40px;
      background: #fff;
      transition: all 0.3s;
    }
    .logo-wall.layout-flex {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
    }
    .logo-entry {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 18px 12px;
      border-radius: 12px;
      transition: all 0.3s;
    }
    .logo-entry:hover { transform: translateY(-3px); }
    .logo-entry img {
      width: 64px; height: 64px;
      object-fit: contain;
      border-radius: 14px;
      margin-bottom: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .logo-entry .logo-name {
      font-size: 0.82rem; color: #555; text-align: center; font-weight: 500;
      max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .logo-entry .logo-category {
      font-size: 0.72rem; color: #667eea; text-align: center;
      max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-top: 2px;
    }
    .logo-wall.hide-names .logo-entry .logo-name,
    .logo-wall.hide-names .logo-entry .logo-category { display: none; }
    .logo-wall.grayscale .logo-entry img { filter: grayscale(100%); transition: filter 0.3s; }
    .logo-wall.grayscale .logo-entry:hover img { filter: grayscale(0%); }

    .tag-product { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.72rem; font-weight: 600; background: #667eea22; color: #667eea; }
    .tag-region { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.72rem; font-weight: 600; background: #52c41a22; color: #389e0d; }

    /* åŠ è½½åŠ¨ç”» */
    .loading {
      text-align: center;
      padding: 60px 20px;
    }
    .spinner {
      width: 40px; height: 40px;
      border: 4px solid #e8e8e8;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* åº•éƒ¨ */
    .footer {
      text-align: center;
      padding: 24px;
      color: #bbb;
      font-size: 0.82rem;
    }
    .footer a { color: #667eea; text-decoration: none; }

    @media (max-width: 768px) {
      .header h1 { font-size: 1.5rem; }
      .header-stats { gap: 16px; }
      .filter-panel { padding: 16px; }
      .logo-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
      .logo-card img { width: 48px; height: 48px; }
      .wall-toolbar { padding: 14px; gap: 10px; }
      .wall-toolbar-actions { margin-left: 0; width: 100%; }
      .result-bar { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>

<div class="header">
  <a href="admin.html" class="admin-link">ç®¡ç†å‘˜å…¥å£</a>
  <h1>Logo å¢™</h1>
  <p>æŒ‰äº§å“ã€åŒºåŸŸã€åˆ†ç±»è‡ªç”±ç»„åˆï¼Œä¸€é”®ç”Ÿæˆå¹¶ä¸‹è½½ Logo å¢™</p>
  <div class="header-stats">
    <div class="header-stat">
      <span class="num" id="statTotal">-</span>
      <span class="label">Logo æ€»æ•°</span>
    </div>
    <div class="header-stat">
      <span class="num" id="statProducts">-</span>
      <span class="label">äº§å“çº¿</span>
    </div>
    <div class="header-stat">
      <span class="num" id="statRegions">-</span>
      <span class="label">å›½å®¶/åŒºåŸŸ</span>
    </div>
    <div class="header-stat">
      <span class="num" id="statCategories">-</span>
      <span class="label">è¡Œä¸šåˆ†ç±»</span>
    </div>
  </div>
</div>

<div class="container">
  <!-- åŠ è½½ä¸­ -->
  <div class="loading" id="loadingState">
    <div class="spinner"></div>
    <p>æ­£åœ¨åŠ è½½ Logo æ•°æ®...</p>
  </div>

  <!-- ä¸»å†…å®¹ -->
  <div id="mainContent" style="display:none;">
    <!-- æœç´¢ -->
    <div class="search-bar">
      <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢ Logo åç§°...">
    </div>

    <!-- ç­›é€‰é¢æ¿ -->
    <div class="filter-panel">
      <div class="filter-section">
        <div class="filter-section-title">ğŸ“¦ äº§å“</div>
        <div class="filter-tags" id="filterProduct"></div>
      </div>
      <div class="filter-section">
        <div class="filter-section-title">ğŸŒ åŒºåŸŸ</div>
        <div class="filter-tags" id="filterRegion"></div>
      </div>
      <div class="filter-section">
        <div class="filter-section-title">ğŸ“‚ è¡Œä¸šåˆ†ç±»</div>
        <div class="filter-tags" id="filterCategory"></div>
      </div>
    </div>

    <!-- ç»“æœç»Ÿè®¡ + æ“ä½œ -->
    <div class="result-bar">
      <div class="result-count">
        å…±ç­›é€‰å‡º <strong id="filteredCount">0</strong> ä¸ª Logoï¼Œå·²é€‰ä¸­ <strong id="selectedCount">0</strong> ä¸ª
      </div>
      <div class="result-actions">
        <button class="btn btn-outline btn-sm" id="selectAllBtn">å…¨é€‰å½“å‰</button>
        <button class="btn btn-outline btn-sm" id="clearSelectionBtn">å–æ¶ˆé€‰æ‹©</button>
        <button class="btn btn-primary btn-sm" id="generateWallBtn" disabled>ç”Ÿæˆ Logo å¢™</button>
        <button class="btn btn-excel btn-sm" id="exportExcelBtn" disabled>å¯¼å‡º Excel</button>
        <button class="btn btn-ppt btn-sm" id="exportPptBtn" disabled>å¯¼å‡º PPT</button>
      </div>
    </div>

    <!-- Logo ç½‘æ ¼ -->
    <div class="logo-grid" id="logoGrid"></div>

    <!-- ç©ºçŠ¶æ€ -->
    <div class="empty-state" id="emptyState" style="display:none;">
      <div class="icon">ğŸ”</div>
      <h3>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ Logo</h3>
      <p>è¯•è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶</p>
    </div>

    <!-- Logo å¢™å±•ç¤º -->
    <div class="wall-section" id="wallSection">
      <div class="wall-toolbar">
        <label>å¸ƒå±€ <select id="wallLayout"><option value="grid">ç½‘æ ¼</option><option value="flex">å¼¹æ€§</option></select></label>
        <label>Logo å¤§å° <input type="range" id="wallSize" min="40" max="120" value="64"></label>
        <label>é—´è· <input type="range" id="wallGap" min="12" max="60" value="28"></label>
        <label>èƒŒæ™¯è‰² <input type="color" id="wallBg" value="#ffffff"></label>
        <label><input type="checkbox" id="wallGrayscale"> ç°åº¦</label>
        <label><input type="checkbox" id="wallHideNames"> éšè—åç§°</label>
        <div class="wall-toolbar-actions">
          <button class="btn btn-primary btn-sm" id="wallExportImgBtn">å¯¼å‡ºå›¾ç‰‡</button>
          <button class="btn btn-excel btn-sm" id="wallExportExcelBtn">å¯¼å‡º Excel</button>
          <button class="btn btn-ppt btn-sm" id="wallExportPptBtn">å¯¼å‡º PPT</button>
          <button class="btn btn-outline btn-sm" id="wallBackBtn">è¿”å›åˆ—è¡¨</button>
        </div>
      </div>
      <div class="logo-wall-wrapper" id="wallWrapper">
        <div class="logo-wall" id="logoWall"></div>
      </div>
    </div>
  </div>
</div>

<div class="footer">
  Logo æ•°æ®ç”±ç®¡ç†å‘˜ç»´æŠ¤ Â· <a href="admin.html">ç®¡ç†å‘˜å…¥å£</a>
</div>

<script>
  // ============ æ•°æ® ============
  let allLogos = [];
  let filteredLogos = [];
  let selectedIds = new Set();

  // ç­›é€‰çŠ¶æ€
  let filterProduct = 'all';
  let filterRegion = 'all';
  let filterCategory = 'all';
  let searchQuery = '';

  // ============ IndexedDBï¼ˆä¸ admin.html å…±äº«åŒä¸€ä¸ªåº“ï¼‰ ============
  const DB_NAME = 'logo_wall_db';
  const DB_VERSION = 1;
  const STORE_NAME = 'logos';

  function openDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          db.createObjectStore(STORE_NAME, { keyPath: 'id' });
        }
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  async function loadFromIndexedDB() {
    try {
      const db = await openDB();
      return new Promise((resolve) => {
        const tx = db.transaction(STORE_NAME, 'readonly');
        const store = tx.objectStore(STORE_NAME);
        const req = store.getAll();
        let result = [];
        req.onsuccess = () => { result = req.result || []; };
        req.onerror = () => { result = []; };
        tx.oncomplete = () => { db.close(); resolve(result); };
        tx.onerror = () => { db.close(); resolve([]); };
      });
    } catch(e) { console.warn('IndexedDB è¯»å–å¤±è´¥:', e); return []; }
  }

  // ============ åŠ è½½æ•°æ® ============
  async function loadData() {
    // 1. ä¼˜å…ˆä» data/logos.json åŠ è½½ï¼ˆGitHub ä¸Šçš„å…±äº«æ•°æ®ï¼Œæ‰€æœ‰äººå¯è§ï¼‰
    try {
      const res = await fetch('data/logos.json?t=' + Date.now());
      if (res.ok) {
        const jsonData = await res.json();
        if (Array.isArray(jsonData) && jsonData.length > 0) {
          allLogos = jsonData;
        }
      }
    } catch (e) {}

    // 2. å¦‚æœ JSON ä¸ºç©ºï¼Œå°è¯•ä» IndexedDB åŠ è½½ï¼ˆæœ¬åœ°ç®¡ç†å‘˜æ•°æ®ï¼‰
    if (allLogos.length === 0) {
      allLogos = await loadFromIndexedDB();
    }

    // 3. å¦‚æœä»ç„¶ä¸ºç©ºï¼Œæ˜¾ç¤ºå¯¼å…¥æç¤º
    if (allLogos.length === 0) {
      document.getElementById('loadingState').innerHTML = `
        <div style="text-align:center;padding:40px 20px;">
          <p style="font-size:1.1rem;color:#666;margin-bottom:16px;">æš‚æ—  Logo æ•°æ®</p>
          <p style="font-size:0.9rem;color:#999;margin-bottom:20px;">è¯·å…ˆåœ¨ <a href="admin.html" style="color:#667eea;">ç®¡ç†åå°</a> ä¸Šä¼  Logoï¼Œæˆ–ç›´æ¥å¯¼å…¥ JSON æ•°æ®æ–‡ä»¶</p>
          <button id="viewerImportBtn" style="padding:10px 24px;background:#667eea;color:#fff;border:none;border-radius:8px;font-size:0.95rem;cursor:pointer;">ğŸ“¥ å¯¼å…¥ JSON æ•°æ®</button>
          <input type="file" id="viewerImportInput" accept=".json" style="display:none;">
        </div>
      `;
      document.getElementById('viewerImportBtn').addEventListener('click', () => {
        document.getElementById('viewerImportInput').click();
      });
      document.getElementById('viewerImportInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (ev) => {
          try {
            const data = JSON.parse(ev.target.result);
            if (!Array.isArray(data) || data.length === 0) { alert('JSON æ ¼å¼é”™è¯¯æˆ–ä¸ºç©º'); return; }
            const db = await openDB();
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            store.clear();
            data.forEach((item, i) => {
              if (!item.id) item.id = Date.now() + '_' + i + '_' + Math.random().toString(36).slice(2,8);
              if (item.src) store.put(item);
            });
            await new Promise((resolve) => { tx.oncomplete = () => { db.close(); resolve(); }; });
            allLogos = data.filter(item => item.src);
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            updateStats();
            buildFilters();
            applyFilters();
            alert(`âœ… æˆåŠŸå¯¼å…¥ ${allLogos.length} ä¸ª Logoï¼`);
          } catch (err) { alert('å¯¼å…¥å¤±è´¥: ' + err.message); }
        };
        reader.readAsText(file);
      });
      return;
    }

    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';

    updateStats();
    buildFilters();
    applyFilters();
  }

  // ============ ç»Ÿè®¡ ============
  function updateStats() {
    document.getElementById('statTotal').textContent = allLogos.length;
    document.getElementById('statProducts').textContent = new Set(allLogos.map(l => l.product).filter(Boolean)).size;
    document.getElementById('statRegions').textContent = new Set(allLogos.map(l => l.region).filter(Boolean)).size;
    document.getElementById('statCategories').textContent = new Set(allLogos.map(l => l.category).filter(Boolean)).size;
  }

  // ============ æ„å»ºç­›é€‰å™¨ ============
  function buildFilters() {
    // äº§å“
    const products = {};
    allLogos.forEach(l => { if (l.product) products[l.product] = (products[l.product] || 0) + 1; });
    buildFilterTags('filterProduct', products, 'product', 'active');

    // åŒºåŸŸ
    const regions = {};
    allLogos.forEach(l => { if (l.region) regions[l.region] = (regions[l.region] || 0) + 1; });
    buildFilterTags('filterRegion', regions, 'region', 'active-green');

    // åˆ†ç±»
    const categories = {};
    allLogos.forEach(l => { if (l.category) categories[l.category] = (categories[l.category] || 0) + 1; });
    // æŒ‰æ•°é‡æ’åº
    const sortedCats = Object.entries(categories).sort((a, b) => b[1] - a[1]);
    const sortedCatObj = {};
    sortedCats.forEach(([k, v]) => sortedCatObj[k] = v);
    buildFilterTags('filterCategory', sortedCatObj, 'category', 'active-orange');
  }

  function buildFilterTags(containerId, dataMap, filterType, activeClass) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';

    // å…¨éƒ¨æŒ‰é’®
    const total = Object.values(dataMap).reduce((a, b) => a + b, 0);
    const allTag = document.createElement('span');
    allTag.className = 'filter-tag active';
    allTag.textContent = 'å…¨éƒ¨';
    allTag.dataset.value = 'all';
    allTag.addEventListener('click', () => {
      setFilter(filterType, 'all');
      updateFilterUI(containerId, 'all', activeClass);
    });
    container.appendChild(allTag);

    Object.entries(dataMap).forEach(([key, count]) => {
      const tag = document.createElement('span');
      tag.className = 'filter-tag';
      tag.innerHTML = `${key}<span class="tag-count">(${count})</span>`;
      tag.dataset.value = key;
      tag.addEventListener('click', () => {
        setFilter(filterType, key);
        updateFilterUI(containerId, key, activeClass);
      });
      container.appendChild(tag);
    });
  }

  function updateFilterUI(containerId, activeValue, activeClass) {
    const container = document.getElementById(containerId);
    container.querySelectorAll('.filter-tag').forEach(tag => {
      tag.classList.remove('active', 'active-green', 'active-orange');
      if (tag.dataset.value === activeValue) {
        tag.classList.add(activeValue === 'all' ? 'active' : activeClass);
      }
    });
  }

  function setFilter(type, value) {
    if (type === 'product') filterProduct = value;
    else if (type === 'region') filterRegion = value;
    else if (type === 'category') filterCategory = value;
    applyFilters();
  }

  // ============ æœç´¢ ============
  document.getElementById('searchInput').addEventListener('input', (e) => {
    searchQuery = e.target.value.trim().toLowerCase();
    applyFilters();
  });

  // ============ åº”ç”¨ç­›é€‰ ============
  function applyFilters() {
    filteredLogos = allLogos.filter(logo => {
      if (filterProduct !== 'all' && logo.product !== filterProduct) return false;
      if (filterRegion !== 'all' && logo.region !== filterRegion) return false;
      if (filterCategory !== 'all' && logo.category !== filterCategory) return false;
      if (searchQuery && !(logo.name || '').toLowerCase().includes(searchQuery)) return false;
      return true;
    });

    // æ¸…ç†æ— æ•ˆé€‰ä¸­
    selectedIds = new Set([...selectedIds].filter(id => filteredLogos.some(l => l.id === id)));

    renderGrid();
    updateResultBar();
  }

  // ============ æ¸²æŸ“ Logo ç½‘æ ¼ ============
  function renderGrid() {
    const grid = document.getElementById('logoGrid');
    const empty = document.getElementById('emptyState');

    if (filteredLogos.length === 0) {
      grid.innerHTML = '';
      empty.style.display = 'block';
      return;
    }

    empty.style.display = 'none';
    grid.innerHTML = '';

    filteredLogos.forEach(logo => {
      const card = document.createElement('div');
      card.className = 'logo-card' + (selectedIds.has(logo.id) ? ' selected' : '');
      card.innerHTML = `
        <div class="card-check">âœ“</div>
        <img src="${logo.src}" alt="${logo.name || ''}">
        <div class="card-name">${logo.name || 'æœªå‘½å'}</div>
        <div class="card-tags">
          ${logo.product ? `<span class="mini-tag product">${logo.product}</span>` : ''}
          ${logo.region ? `<span class="mini-tag region">${logo.region}</span>` : ''}
          ${logo.category ? `<span class="mini-tag category">${logo.category}</span>` : ''}
        </div>
      `;
      card.addEventListener('click', () => {
        if (selectedIds.has(logo.id)) {
          selectedIds.delete(logo.id);
          card.classList.remove('selected');
        } else {
          selectedIds.add(logo.id);
          card.classList.add('selected');
        }
        updateResultBar();
      });
      grid.appendChild(card);
    });
  }

  // ============ æ›´æ–°ç»“æœæ  ============
  function updateResultBar() {
    document.getElementById('filteredCount').textContent = filteredLogos.length;
    document.getElementById('selectedCount').textContent = selectedIds.size;

    const hasSelection = selectedIds.size > 0;
    document.getElementById('generateWallBtn').disabled = !hasSelection;
    document.getElementById('exportExcelBtn').disabled = !hasSelection;
    document.getElementById('exportPptBtn').disabled = !hasSelection;
  }

  // ============ å…¨é€‰ / å–æ¶ˆ ============
  document.getElementById('selectAllBtn').addEventListener('click', () => {
    const allSelected = filteredLogos.every(l => selectedIds.has(l.id));
    if (allSelected) {
      filteredLogos.forEach(l => selectedIds.delete(l.id));
    } else {
      filteredLogos.forEach(l => selectedIds.add(l.id));
    }
    renderGrid();
    updateResultBar();
  });

  document.getElementById('clearSelectionBtn').addEventListener('click', () => {
    selectedIds.clear();
    renderGrid();
    updateResultBar();
  });

  // ============ è·å–é€‰ä¸­çš„Logoåˆ—è¡¨ ============
  function getSelectedLogos() {
    return allLogos.filter(l => selectedIds.has(l.id));
  }

  // ============ ç”Ÿæˆ Logo å¢™ ============
  const wallSection = document.getElementById('wallSection');
  const logoWall = document.getElementById('logoWall');
  const wallLayout = document.getElementById('wallLayout');
  const wallSize = document.getElementById('wallSize');
  const wallGap = document.getElementById('wallGap');
  const wallBg = document.getElementById('wallBg');
  const wallGrayscale = document.getElementById('wallGrayscale');
  const wallHideNames = document.getElementById('wallHideNames');

  let wallEntries = [];

  document.getElementById('generateWallBtn').addEventListener('click', () => {
    wallEntries = getSelectedLogos();
    if (wallEntries.length === 0) return;
    renderWall();
    wallSection.classList.add('visible');
    wallSection.scrollIntoView({ behavior: 'smooth' });
  });

  function renderWall() {
    const size = wallSize.value + 'px';
    const gap = wallGap.value + 'px';
    const layout = wallLayout.value;

    logoWall.innerHTML = '';
    logoWall.className = 'logo-wall';

    if (layout === 'grid') {
      logoWall.style.display = 'grid';
      logoWall.style.gridTemplateColumns = `repeat(auto-fill, minmax(${parseInt(wallSize.value) + 60}px, 1fr))`;
      logoWall.style.gap = gap;
      logoWall.style.flexWrap = '';
      logoWall.style.justifyContent = '';
    } else {
      logoWall.classList.add('layout-flex');
      logoWall.style.display = 'flex';
      logoWall.style.gap = gap;
      logoWall.style.gridTemplateColumns = '';
    }

    logoWall.style.backgroundColor = wallBg.value;
    if (wallGrayscale.checked) logoWall.classList.add('grayscale');
    if (wallHideNames.checked) logoWall.classList.add('hide-names');

    wallEntries.forEach(entry => {
      const div = document.createElement('div');
      div.className = 'logo-entry';

      const img = document.createElement('img');
      img.src = entry.src;
      img.alt = entry.name;
      img.style.width = size;
      img.style.height = size;

      const nameEl = document.createElement('div');
      nameEl.className = 'logo-name';
      nameEl.textContent = entry.name;
      nameEl.style.maxWidth = parseInt(wallSize.value) + 40 + 'px';

      div.appendChild(img);
      div.appendChild(nameEl);

      if (entry.category) {
        const catEl = document.createElement('div');
        catEl.className = 'logo-category';
        catEl.textContent = entry.category + (entry.subcategory ? ' > ' + entry.subcategory : '');
        div.appendChild(catEl);
      }

      logoWall.appendChild(div);
    });
  }

  wallLayout.addEventListener('change', renderWall);
  wallSize.addEventListener('input', renderWall);
  wallGap.addEventListener('input', renderWall);
  wallBg.addEventListener('input', () => { logoWall.style.backgroundColor = wallBg.value; });
  wallGrayscale.addEventListener('change', () => { logoWall.classList.toggle('grayscale', wallGrayscale.checked); });
  wallHideNames.addEventListener('change', () => { logoWall.classList.toggle('hide-names', wallHideNames.checked); });

  document.getElementById('wallBackBtn').addEventListener('click', () => {
    wallSection.classList.remove('visible');
  });

  // ============ å¯¼å‡ºå›¾ç‰‡ ============
  document.getElementById('wallExportImgBtn').addEventListener('click', () => {
    const btn = document.getElementById('wallExportImgBtn');
    btn.textContent = 'å¯¼å‡ºä¸­...';
    btn.disabled = true;

    const wrapper = document.getElementById('wallWrapper');
    const rect = wrapper.getBoundingClientRect();
    const scale = 2;
    const canvas = document.createElement('canvas');
    canvas.width = rect.width * scale;
    canvas.height = rect.height * scale;
    const ctx = canvas.getContext('2d');
    ctx.scale(scale, scale);
    ctx.fillStyle = wallBg.value;
    ctx.fillRect(0, 0, rect.width, rect.height);

    const entries = document.querySelectorAll('.logo-entry');
    let loaded = 0;
    const total = entries.length;
    if (total === 0) { btn.textContent = 'å¯¼å‡ºå›¾ç‰‡'; btn.disabled = false; return; }

    entries.forEach(entry => {
      const img = entry.querySelector('img');
      const nameEl = entry.querySelector('.logo-name');
      const imgRect = img.getBoundingClientRect();
      const nameRect = nameEl ? nameEl.getBoundingClientRect() : null;

      const image = new Image();
      image.onload = () => {
        let dx = imgRect.left - rect.left;
        let dy = imgRect.top - rect.top;

        if (wallGrayscale.checked) {
          const tc = document.createElement('canvas');
          tc.width = imgRect.width * scale;
          tc.height = imgRect.height * scale;
          const tctx = tc.getContext('2d');
          tctx.scale(scale, scale);
          tctx.filter = 'grayscale(100%)';
          tctx.drawImage(image, 0, 0, imgRect.width, imgRect.height);
          ctx.drawImage(tc, dx, dy, imgRect.width, imgRect.height);
        } else {
          ctx.drawImage(image, dx, dy, imgRect.width, imgRect.height);
        }

        if (nameEl && !wallHideNames.checked) {
          const style = getComputedStyle(nameEl);
          ctx.font = `${style.fontWeight} ${style.fontSize} ${style.fontFamily}`;
          ctx.fillStyle = style.color;
          ctx.textAlign = 'center';
          ctx.fillText(nameEl.textContent, nameRect.left - rect.left + nameRect.width / 2, nameRect.top - rect.top + parseInt(style.fontSize));
        }

        loaded++;
        if (loaded === total) {
          const link = document.createElement('a');
          link.download = 'logo-wall.png';
          link.href = canvas.toDataURL('image/png');
          link.click();
          btn.textContent = 'å¯¼å‡ºå›¾ç‰‡';
          btn.disabled = false;
        }
      };
      image.src = img.src;
    });
  });

  // ============ å¯¼å‡º Excel ============
  async function doExportExcel(items, btnEl) {
    if (!items || items.length === 0) { alert('è¯·å…ˆé€‰æ‹© Logo'); return; }
    const origText = btnEl.textContent;
    btnEl.textContent = 'å¯¼å‡ºä¸­...';
    btnEl.disabled = true;

    try {
      const wb = new ExcelJS.Workbook();
      const ws = wb.addWorksheet('Logoåˆ—è¡¨');
      ws.columns = [
        { header: 'Logo', key: 'logo', width: 12 },
        { header: 'åº”ç”¨åç§°', key: 'name', width: 20 },
        { header: 'äº§å“', key: 'product', width: 10 },
        { header: 'åœ°åŒº', key: 'region', width: 14 },
        { header: 'å¤§åˆ†ç±»', key: 'major', width: 16 },
        { header: 'å°åˆ†ç±»', key: 'minor', width: 16 },
      ];

      const headerRow = ws.getRow(1);
      headerRow.height = 24;
      headerRow.eachCell(cell => {
        cell.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 12 };
        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF667EEA' } };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
      });

      for (let i = 0; i < items.length; i++) {
        const entry = items[i];
        const rowIdx = i + 2;
        const row = ws.addRow(['', entry.name || '', entry.product || '', entry.region || '', entry.category || '', entry.subcategory || '']);
        row.height = 55;
        row.eachCell(cell => {
          cell.alignment = { horizontal: 'center', vertical: 'middle' };
          cell.border = { bottom: { style: 'thin', color: { argb: 'FFDDDDDD' } } };
        });

        if (entry.src && entry.src.startsWith('data:image')) {
          const base64Data = entry.src.split(',')[1];
          const ext = entry.src.includes('image/png') ? 'png' : 'jpeg';
          const imageId = wb.addImage({ base64: base64Data, extension: ext });
          ws.addImage(imageId, { tl: { col: 0.15, row: rowIdx - 1 + 0.1 }, ext: { width: 50, height: 50 } });
        }
      }

      const buffer = await wb.xlsx.writeBuffer();
      const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      saveAs(blob, 'logo-wall.xlsx');
    } catch (err) {
      console.error('Excelå¯¼å‡ºå¤±è´¥:', err);
      alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
    btnEl.textContent = origText;
    btnEl.disabled = false;
  }

  document.getElementById('exportExcelBtn').addEventListener('click', () => {
    doExportExcel(getSelectedLogos(), document.getElementById('exportExcelBtn'));
  });
  document.getElementById('wallExportExcelBtn').addEventListener('click', () => {
    doExportExcel(wallEntries, document.getElementById('wallExportExcelBtn'));
  });

  // ============ å¯¼å‡º PPT ============
  async function doExportPpt(items, btnEl) {
    if (!items || items.length === 0) { alert('è¯·å…ˆé€‰æ‹© Logo'); return; }
    const origText = btnEl.textContent;
    btnEl.textContent = 'å¯¼å‡ºä¸­...';
    btnEl.disabled = true;

    try {
      const pptx = new PptxGenJS();
      pptx.layout = 'LAYOUT_WIDE';
      pptx.title = 'Logo å¢™';

      // åˆ†ç»„
      const grouped = {};
      items.forEach(item => {
        const key = item.category || 'æœªåˆ†ç±»';
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(item);
      });

      // å°é¢
      const cover = pptx.addSlide();
      cover.background = { fill: '667EEA' };
      cover.addText('Logo å¢™', {
        x: 0.5, y: 1.5, w: '90%', h: 1.2,
        fontSize: 44, fontFace: 'Microsoft YaHei', color: 'FFFFFF', bold: true, align: 'center'
      });
      const parts = [];
      if (filterProduct !== 'all') parts.push('äº§å“ï¼š' + filterProduct);
      if (filterRegion !== 'all') parts.push('åŒºåŸŸï¼š' + filterRegion);
      if (filterCategory !== 'all') parts.push('åˆ†ç±»ï¼š' + filterCategory);
      parts.push('å…± ' + items.length + ' ä¸ª Logo');
      cover.addText(parts.join('ã€€|ã€€'), {
        x: 0.5, y: 2.8, w: '90%', h: 0.6,
        fontSize: 18, fontFace: 'Microsoft YaHei', color: 'DDDDFF', align: 'center'
      });
      cover.addText(new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' }), {
        x: 0.5, y: 3.5, w: '90%', h: 0.4,
        fontSize: 14, fontFace: 'Microsoft YaHei', color: 'BBBBEE', align: 'center'
      });

      // æ€»è§ˆé¡µ
      const COLS = 8, LOGO_SIZE = 0.75, GAP_X = 0.4, GAP_Y = 0.45, START_X = 0.5, START_Y = 1.0, ROWS = 5;
      for (let page = 0; page * COLS * ROWS < items.length; page++) {
        const slide = pptx.addSlide();
        slide.background = { fill: 'FFFFFF' };
        slide.addText('Logo æ€»è§ˆ', { x: 0.3, y: 0.15, w: '95%', h: 0.6, fontSize: 24, fontFace: 'Microsoft YaHei', color: '333333', bold: true });
        const startIdx = page * COLS * ROWS;
        const endIdx = Math.min(startIdx + COLS * ROWS, items.length);
        for (let i = startIdx; i < endIdx; i++) {
          const idx = i - startIdx;
          const col = idx % COLS;
          const row = Math.floor(idx / COLS);
          const x = START_X + col * (LOGO_SIZE + GAP_X);
          const y = START_Y + row * (LOGO_SIZE + GAP_Y + 0.35);
          const entry = items[i];
          if (entry.src && entry.src.startsWith('data:image')) {
            slide.addImage({ data: entry.src, x: x + (LOGO_SIZE - 0.65) / 2, y, w: 0.65, h: 0.65, rounding: true });
          }
          slide.addText(entry.name || '', {
            x: x - 0.1, y: y + 0.68, w: LOGO_SIZE + 0.2, h: 0.28,
            fontSize: 7, fontFace: 'Microsoft YaHei', color: '555555', align: 'center', valign: 'top', wrap: false
          });
        }
      }

      // åˆ†ç±»è¯¦æƒ…é¡µ
      Object.entries(grouped).sort((a, b) => b[1].length - a[1].length).forEach(([cat, catItems]) => {
        const slide = pptx.addSlide();
        slide.background = { fill: 'FAFBFC' };
        slide.addShape(pptx.shapes.RECTANGLE, { x: 0, y: 0, w: '100%', h: 0.8, fill: { color: '667EEA' } });
        slide.addText(`${cat}ï¼ˆ${catItems.length}ï¼‰`, { x: 0.4, y: 0.1, w: 8, h: 0.6, fontSize: 22, fontFace: 'Microsoft YaHei', color: 'FFFFFF', bold: true });

        const rows = [[
          { text: 'Logo', options: { bold: true, color: 'FFFFFF', fill: { color: '667EEA' }, align: 'center', fontSize: 10 } },
          { text: 'åç§°', options: { bold: true, color: 'FFFFFF', fill: { color: '667EEA' }, align: 'center', fontSize: 10 } },
          { text: 'äº§å“', options: { bold: true, color: 'FFFFFF', fill: { color: '667EEA' }, align: 'center', fontSize: 10 } },
          { text: 'åŒºåŸŸ', options: { bold: true, color: 'FFFFFF', fill: { color: '667EEA' }, align: 'center', fontSize: 10 } },
          { text: 'å¤§åˆ†ç±»', options: { bold: true, color: 'FFFFFF', fill: { color: '667EEA' }, align: 'center', fontSize: 10 } },
          { text: 'å°åˆ†ç±»', options: { bold: true, color: 'FFFFFF', fill: { color: '667EEA' }, align: 'center', fontSize: 10 } }
        ]];
        const pageItems = catItems.slice(0, 10);
        pageItems.forEach(e => {
          rows.push([
            { text: '', options: { align: 'center', fontSize: 9 } },
            { text: e.name || '', options: { align: 'center', fontSize: 9 } },
            { text: e.product || '', options: { align: 'center', fontSize: 9, color: '667EEA' } },
            { text: e.region || '', options: { align: 'center', fontSize: 9, color: '389E0D' } },
            { text: e.category || '', options: { align: 'center', fontSize: 9 } },
            { text: e.subcategory || '', options: { align: 'center', fontSize: 9 } }
          ]);
        });
        slide.addTable(rows, { x: 0.3, y: 1.0, w: 12.5, colW: [1.2, 2.5, 1.5, 1.8, 2.5, 2.5], rowH: 0.45, border: { type: 'solid', pt: 0.5, color: 'DDDDDD' }, autoPage: false });
        pageItems.forEach((e, i) => {
          if (e.src && e.src.startsWith('data:image')) {
            slide.addImage({ data: e.src, x: 0.5, y: 1.0 + 0.45 + i * 0.45 + 0.03, w: 0.35, h: 0.35, rounding: true });
          }
        });
        if (catItems.length > 10) {
          slide.addText(`...åŠå…¶ä»– ${catItems.length - 10} ä¸ª`, { x: 0.3, y: 6.8, w: 5, h: 0.3, fontSize: 10, fontFace: 'Microsoft YaHei', color: '999999', italic: true });
        }
      });

      const pptData = await pptx.write({ outputType: 'blob' });
      saveAs(pptData, 'logo-wall.pptx');
    } catch (err) {
      console.error('PPTå¯¼å‡ºå¤±è´¥:', err);
      alert('PPTå¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
    btnEl.textContent = origText;
    btnEl.disabled = false;
  }

  document.getElementById('exportPptBtn').addEventListener('click', () => {
    doExportPpt(getSelectedLogos(), document.getElementById('exportPptBtn'));
  });
  document.getElementById('wallExportPptBtn').addEventListener('click', () => {
    doExportPpt(wallEntries, document.getElementById('wallExportPptBtn'));
  });

  // å¯åŠ¨
  loadData();
</script>

</body>
</html>
